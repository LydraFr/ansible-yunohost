# R√¥le Ansible : Yunohost

[üá¨üáß English version](README.md)

D√©ployez [Yunohost](https://yunohost.org/#/) avec Ansible !

## Pr√©requis

Aucun.

## Variables du r√¥le

Les variables par d√©faut sont disponibles dans `default/main.yml` cependant il est n√©cessaire de les surcharger selon vos besoins en termes de domaines, d'utilisateurs et d'applications sur Yunohost.

### Installation de Yunohost

```yml
# Script pour Debian 10 uniquement.
ynh_install_script_url: https://install.yunohost.org

ynh_admin_password: MYINSECUREPWD_PLZ_OVERRIDE_THIS
```

- `ynh_install_script_url` est le script d'installation des packages Yunohost, par d√©faut c'est le script officiel. Yunohost ne s'installe que sur Debian 10.
- `ynh_admin_password` est le mot de passe permettant d'acc√©der √† l‚Äôinterface d‚Äôadministration du serveur.

### Gestion des domaines

```yml
# Liste des domaines g√©r√©s par Yunohost.
ynh_main_domain: domain.tld
ynh_extra_domains:
  - forum.domain.tld
  - wiki.domain.tld
ynh_ignore_dyndns_server: False
```

- `ynh_main_domain` correspond au domaine principal qui permet l‚Äôacc√®s au serveur ainsi qu‚Äôau portail d‚Äôauthentification des utilisateurs. On peut se contenter d'un nom de domaine qui nous appartient ou en utiliser un en .nohost.me / .noho.st / .ynh.fr (plus d'infos [ici](https://yunohost.org/fr/install/hardware:vps_debian)).
- `ynh_extra_domains` sont des sous-domaines optionnels. Ils permettent d'installer une application par sous-domaine (plus d'infos [ici](https://yunohost.org/fr/dns_subdomains)).
- `ynh_ignore_dyndns_server` permet d'enregistrer les domaines avec un service de DNS dynamique (plus d'infos [ici](https://yunohost.org/fr/dns_dynamicip)).

### Gestion des utilisateurs

```yml
# Liste des utilisateurs Yunohost.
ynh_users:
   - name: user1
     pass: MYINSECUREPWD_PLZ_OVERRIDE_THIS
     firstname: Jane
     lastname: Doe
     mail_domain: domain.tld 
```

- `ynh_users` est la liste des utilisateurs √† cr√©er. Chaque champ est obligatoire. Certaines applications Yunohost n√©cessitent qu'un utilisateur soit administrateur de l'application. Il aura ensuite le droit de g√©rer l'application depuis l'interface l'administration du serveur. Vous pouvez en apprendre plus sur la gestion des utilisateurs Yunohost [ici](https://yunohost.org/fr/administrate/overview/users).

### Gestion des applications

```yml
# Liste des applications Yunohost.
ynh_apps:
  - label: WikiJS
    link: wikijs
    args:
      domain: wiki.domain.tld
      path: /
      admin: user1
      is_public: no
  - label: Discourse
    link: discourse
    args:
      domain: forum.domain.tld
      path: /
      admin: user1
      is_public: yes
    post_install:
      - src: "templates/site_settings.yml.j2"
        dest: "/var/www/discourse/config/site_settings.yml"
        type: "config"

      - src: "templates/configure_discourse.sh.j2"
        dest: "/tmp/configure_discourse.sh"
        type: "script"
        owner: root
        group: root
```

- `ynh_apps` est la liste des applications √† installer.
- `label` permet de donner un nom personnalis√© √† l'application sur l'interface utilisateur.
- `link` correspond au nom de l'application Yunohost qu'on veut installer.

#### Concernant les arguments

- `domain` est obligatoire. Il faut choisir un des domaines de son instance Yunohost.
- `path` est obligatoire. Il faut choisir une URL pour acc√©der √† son application comme `domain.tld/my_app`. Utilisez juste `/` si l'application doit s'installer sur un sous-domaine.
- `is_public` est  un argument qu'on retrouve souvent. Param√©tr√© sur `yes`, l'application sera accessible √† tout le monde, m√™me sans authentification sur le portail SSO Yunohost. Param√©tr√© sur `no`, l'application ne sera accessible qu'apr√®s authentification.

Pour les autres arguments, il faut se r√©f√©rer au `manifest.json` disponible dans le d√©p√¥t de l'application Yunohost qu'on installe. Vous pouvez en apprendre plus sur cette partie [ici](https://yunohost.org/fr/packaging_apps_manifest).

#### Concernant la post-installation

Il est possible de compl√©ter l'installation des applications par l'ajout de templates jinja de configuration ou de scripts que vous aurez √©crit de votre c√¥t√©.
Pour activer cette fonctionnalit√©, d√©finissez la variable `post_install` qui correspond √† la liste des fichiers de post-installation de votre application.
Cette t√¢che utilisant le module template, vous pouvez tout √† fait utiliser vos propres variables et les appeler dans vos fichiers de template. Pour en savoir sur ce module, cliquez [ici](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html).

- `src` est obligatoire. Il s'agit du r√©pertoire o√π le fichier de template se situe sur la machine qui execute Ansible.
- `dest` est obligatoire. Il s'agit du r√©pertoire o√π le fichier de template va √™tre stock√©.
- `type` est obligatoire :
  - Si vous pr√©cisez comme valeur `script` alors le fichier de template aura pour droits 740. Il sera ex√©cut√© apr√®s son transfert sur le serveur Yunohost (g√©n√©ralement dans `/tmp/`) puis il sera supprim√©. 
  - Si vous pr√©cisez comme valeur `config` alors le fichier de template aura pour droits 660. Il sera transf√©r√© sur le serveur Yunohost (g√©n√©ralement dans `/var/www/AppName/`) et vous pourrez l'importer avec un script shell √† c√¥t√© par exemple.

Pour `owner` et `group`, par d√©faut le fichier va prendre comme utilisateur propri√©taire le nom de l'application et comme groupe propri√©taire www-data (groupe NGINX). Vous pouvez les changer en pr√©cisant des valeurs diff√©rentes.

## D√©pendances

Aucune.

## Exemple de Playbook

```yml
---
- name: Install Yunohost on Debian Server
  hosts: all
  become: True
  collections:
    - lydra.yunohost
  pre_tasks:
    - name: Update all packages and index
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes
    
  roles:
    - ynh_setup
    - ynh_config
    - ynh_backup
```

## License

[![ansible-yunohost Copyright 2021 Lydra](https://www.gnu.org/graphics/gplv3-with-text-136x68.png)](https://choosealicense.com/licenses/gpl-3.0/)

**ansible-yunohost** est maintenu par [Lydra](https://lydra.fr/) et publi√© sous la licence GPL3.
